{% extends "PlantnetDataBundle:Frontend:layout.html.twig" %}
{% block title project|capitalize ~ ' - ' ~ collection.name ~ ' - ' ~ module.name ~ ' - ' ~ "line-taxonomy"|trans|capitalize %}
{% block stylesheets %}
	{{ parent() }}
{% endblock %}
{% block header %}<h1>{{ module.name }} - {{ "line-taxonomy"|trans|capitalize }}{% if taxon != 'null' %} - {{ taxon.name }}{% endif %}</h1>{% endblock %}
{% block breadcrumb %}
    <ul class="breadcrumb">
        <li>
            <a href="{{ url('_project', {'project': project}) }}">{{ project|capitalize }}</a>
            <span class="divider">/</span>
        </li>
        <li>
            <a href="{{ path('_collection', { 'project': project, 'collection': collection.url }) }}">{{ collection.name }}</a>
            <span class="divider">/</span>
        </li>
        <li>
            <a href="{{ path('_module', { 'project': project, 'collection': collection.url, 'module': module.url }) }}">{{ module.name }}</a>
            <span class="divider">/</span>
        </li>
        {% if taxon != 'null' %}
            <li>
                <a href="{{ path('_module_taxo', { 'project': project, 'collection': collection.url, 'module': module.url }) }}">{{ "line-taxonomy"|trans|capitalize }}</a>
                <span class="divider">/</span>
            </li>
            {% macro bc_taxon(taxon,project,collection,module) %}
                {% if taxon.parent %}
                    {{ _self.bc_taxon(taxon.parent,project,collection,module) }}
                    <li>
                        <a href="{{ path('_module_taxo_details', { 'project': project, 'collection': collection.url, 'module': module.url, 'level': taxon.parent.level, 'taxon': taxon.parent.name }) }}">{{ taxon.parent.name }}</a>
                        <span class="divider">/</span>
                    </li>
                {% endif %}
            {% endmacro %}
            {% import _self as macros %}
            {{ macros.bc_taxon(taxon,project,collection,module) }}
            <li class="active">
                {{ taxon.name }}
            </li>
        {% else %}
            <li class="active">
                {{ "line-taxonomy"|trans|capitalize }}
            </li>
        {% endif %}
    </ul>
{% endblock %}
{% block side %}
    {% include "PlantnetDataBundle:Frontend:side.html.twig" with { module: module } %}
{% endblock %}
{% block main %}
    <div id="taxo">
        <form method="get" action="{{ path('_module_taxo', { 'project': project, 'collection': collection.url, 'module': module.url }) }}">
            <div class="input-append">
                <input type="text" name="taxon" id="typeahead" class="span4" placeholder="{{ "line-taxon"|trans|capitalize }}" autocomplete="off" data-provide="typeahead">
                <button class="btn" type="submit">Search</button>
            </div>
            <input type="hidden" name="form_level" id="form_level" />
            <input type="hidden" name="form_name" id="form_name" />
        </form>
        <table class="table table-hover table-condensed">
            <tr>
                <th>
                    {{ "line-taxon"|trans|capitalize }}
                </th>
                <th class="span2 middle">
                    {{ "line-specimens"|trans|capitalize }}
                </th>
                <th class="span2 middle">
                    {{ "line-views"|trans|capitalize }}
                </th>
            </tr>
            {% for taxon in taxons %}
                <tr>
                    <td>
                        <span>
                            {% if taxon.haschildren == true %}
                                <a href="{{ path('_module_taxo_details', { 'project': project, 'collection': collection.url, 'module': module.url, 'level': taxon.level, 'taxon': taxon.name }) }}" id="t{{ taxon.id }}" class="display-sub">
                                    <i class="arrow icon-chevron-right"></i>
                                    {{ taxon.name }}
                                </a>
                            {% else %}
                                {{ taxon.name }}
                            {% endif %}
                        </span>
                    </td>
                    <td class="span2 middle">
                        <span class="badge">
                            {{ taxon.nbpunits }}
                            <i class="icon-leaf"></i>
                        </span>
                    </td>
                    <td class="span2 middle">
                        <a href="{{ path('_module_taxo_view', { 'project': project, 'collection': collection.url, 'module': module.url, 'level': taxon.level, 'taxon': taxon.name }) }}" id="t{{ taxon.id }}">
                            <i class="icon-list"></i></a>
                        {% if taxon.hasimages %}
                            <a href="{{ path('_module_taxo_view_gallery', { 'project': project, 'collection': collection.url, 'module': module.url, 'level': taxon.level, 'taxon': taxon.name }) }}" id="t{{ taxon.id }}">
                                <i class="icon-camera"></i></a>
                        {% endif %}
                        {% if taxon.haslocations %}
                            <a href="{{ path('_module_taxo_view_map', { 'project': project, 'collection': collection.url, 'module': module.url, 'level': taxon.level, 'taxon': taxon.name }) }}" id="t{{ taxon.id }}">
                                <i class="icon-map-marker"></i></a>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td id="sub-{{ taxon.id }}" colspan="3" class="sub-content"></td>
                </tr>
            {% endfor %}
        </table>
    </div>
{% endblock %}
{% block javascripts %}
	{{ parent() }}
    <script type="text/javascript">
        $(document).ready(function(){
            $('#typeahead').typeahead({
                source:function(query,process){
                    return $.get('{{ path('_module_taxo_query_path', { 'project': project, 'collection': collection.url, 'module': module.url }) }}/'+query,function(data){
                        var list=data.map(function(item){
                            var tmp_item={level:item.level,name:item.name,label:item.label};
                            return JSON.stringify(tmp_item);
                        });
                        return process(list);
                    });
                },
                highlighter:function (tmp_item){
                    var item=JSON.parse(tmp_item);
                    var query=this.query.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,'\\$&');
                    return item.name.replace(new RegExp('('+query+')','ig'),function($1,match){
                        return '<strong>'+match+'</strong>';
                    })+' ['+item.label+']';
                },
                updater:function(tmp_item){
                    var item=JSON.parse(tmp_item);
                    $('#form_level').val(item.level);
                    $('#form_name').val(item.name);
                    return item.name+' ['+item.label+']';
                },
                items:10
            });
            $(document).on('click','.display-sub',function(event){
                event.preventDefault();
                var parent=$(this);
                var loaded=parent.hasClass('loaded');
                if(!loaded){
                    parent.addClass('loaded');
                }
                var id=parent.attr('id').substring(1);
                if(!loaded){
                    parent.parent('span').append('<span class="taxo_load"></span>');
                    $.ajax({
                        url:'{{ path('_module_taxo_children', { 'project': project, 'collection': collection.url, 'module': module.url }) }}/'+id
                    }).done(function(data){
                        $('#sub-'+id).html(data);
                        parent.parent('span').children('.taxo_load').remove();
                        if(parent.children('.arrow').hasClass('icon-chevron-right')){
                            parent.children('.arrow').removeClass('icon-chevron-right');
                        }
                        if(parent.children('.arrow').hasClass('icon-chevron-down')){
                            parent.children('.arrow').removeClass('icon-chevron-down');
                        }
                        parent.children('.arrow').addClass('icon-chevron-down');
                        $('#sub-'+id).show();
                    });
                }
                else{
                    $('#sub-'+id).toggle(0,function(){
                        if(parent.children('.arrow').hasClass('icon-chevron-right')){
                            parent.children('.arrow').removeClass('icon-chevron-right');
                        }
                        if(parent.children('.arrow').hasClass('icon-chevron-down')){
                            parent.children('.arrow').removeClass('icon-chevron-down');
                        }
                        if($(this).is(':visible')){
                            parent.children('.arrow').addClass('icon-chevron-down');
                        }
                        else{
                            parent.children('.arrow').addClass('icon-chevron-right');
                        }
                    });
                }
                return false;
            });
        });
    </script>
{% endblock %}